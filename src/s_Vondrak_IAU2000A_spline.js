"use strict";
/*
This file contains the function double s_Vondrak_IAU2000A_spline(jd0, jd1)
that calculates the CIO locate s compatible with
Vondrak et al/IAU2000A precession-nutation model at TT Julian date
jd = jd0 + jd1 using a spline fitting formula.

s is returned in radians.

JD must be in the range so that |T| = |(jd-2451545)/36525| <= 60.

The interval [-60,60] are divided into sub-intervals [-60, -40],
[-40, -20], [-20, -5], [-5, 5], [5, 20], [20, 40] and [40, 60].
Each sub-interval has a fitting formula. The inner boundary points
-40, -20, -5, 5, 20 and 40 are the knots in the regression spline.
The function s(T) and its first derivative s'(T) are continuous, but
the second and higher derivatives of s are discontinuous at the knots.

Following SOFA, Julian date is specified by two parts jd0 and jd1 in any way
users may find convenient. For example, JD(TT)=2450123.7 could be expressed
in any of these ways, among others.

            jd0             jd1
         2450123.7           0.0       (JD method)
         2451545.0       -1421.3       (J2000 method)
         2400000.5       50123.2       (MJD method)
         2450123.5           0.2       (date & time method)

Accuracy of the fitting formula:
time period      estimated max error    rms error
--------------------------------------------------
-60 < T < -40          12.5 mas           3.14 mas
-40 < T < -20          7.22 mas           1.64 mas
-20 < T < -5          3.18 mas           0.586 mas
-5 < T < 5            0.622 mas          0.119 mas
5 < T < 20            2.96 mas           0.594 mas
20 < T < 40           7.07 mas           1.66 mas
40 < T < 60           11.9 mas           3.05 mas

The spline fitting formula and code were developed by Yuk Tung Liu in June 2025.
*/

function s_Vondrak_IAU2000A_spline(jd0, jd1) {
    let jd_int = Math.floor(jd0 + jd1);
    let fday = (jd0 - Math.floor(jd0)) + (jd1 - Math.floor(jd1));
    fday -= Math.floor(fday);
    let T = ((jd_int - 2451545) + fday)/36525;

    let F = f_angles(jd_int, fday);
    let cof = set_s_coefficients(T);
    let ang = [F[4], 2*(F[2] - F[3] + F[4]), 2*(F[2] + F[4]), 2*F[4],
                F[1] + 2*(F[2] - F[3] + F[4]), 2*F[2] + F[4], F[0] + 2*(F[2] + F[4]),
                F[1] - 2*(F[2] - F[3] + F[4]), F[1], 2*(F[2] - F[3]) + F[4],
                F[0] - 2*(F[2] - F[4])];
    let Tp = T - cof.T0;
    let s = cof.cpoly[0] + Tp*(cof.cpoly[1] + Tp*(cof.cpoly[2] + Tp*(cof.cpoly[3] +
                            Tp*(cof.cpoly[4] + Tp*cof.cpoly[5]))));
    for (let i=0; i<11; i++) {
        s += (cof.ccos0[i] + Tp*(cof.ccos1[i] + Tp*cof.ccos2[i]))*Math.cos(ang[i]) +
          (cof.csin0[i] + Tp*(cof.csin1[i] + Tp*cof.csin2[i]))*Math.sin(ang[i]);
    }
    return s;
}

// Set the coefficients of the spline fitting formula for s
function set_s_coefficients(T) {
    let T0, cpoly, ccos0, ccos1, ccos2, csin0, csin1, csin2;
    if (Math.abs(T) <= 5) {
        T0 = 0;
        cpoly = [4.57887250562558e-10, 1.85230908250539e-08, 5.37186402517456e-12, 1.75937289911237e-07, -2.22275117440062e-11, -3.18027499764233e-12];
        ccos0 = [-9.21914587186482e-11, 3.80610625299442e-11, 2.86179518570931e-11, 1.12512005290705e-10, 4.97813641673289e-11, 1.62234810377612e-11, 5.38745114103921e-12, -1.93467827566587e-07, -1.51304121127097e-07, -3.3376404816287e-11, -6.050804295359e-11];
        ccos1 = [-2.16508715732828e-07, -1.34739047342258e-08, -2.30476259187194e-09, 2.10276084864552e-09, -5.2369523312137e-10, -4.60286035414753e-10, -3.15045952058511e-10, -2.02634766249315e-09, 2.32269566417457e-09, 1.64249446420379e-10, 5.86557061501365e-12];
        ccos2 = [2.84267712105073e-11, 8.706339960106e-12, 1.26895427713227e-13, -5.1808919095513e-12, -2.05691443711539e-13, -1.1211454845348e-12, -1.05682050139179e-14, 1.05055751256728e-10, -7.54058866917937e-12, 8.27978787363963e-13, 2.55301126012366e-12];
        csin0 = [-1.32451597704387e-08, 9.04794516636391e-12, -8.25771460517828e-12, 6.16098900991987e-11, -1.13778906956243e-11, 6.34149279549574e-11, -3.6976586422211e-11, -5.20870677581513e-08, 1.3121086865233e-07, -5.52018736316723e-11, 1.2837319601937e-11];
        csin1 = [-6.36844163722538e-11, 5.0856768125132e-12, 1.87389023674571e-12, 2.15552129106082e-12, 1.49439013416821e-12, 1.22454192515956e-12, 1.49405974487432e-12, 7.70709151820654e-09, 3.14603957812698e-09, -4.01562898778294e-13, -9.53372596787544e-12];
        csin2 = [-1.78693082886595e-09, -1.37813597162216e-10, -2.4418168171372e-11, 2.16834086578063e-11, -5.49588299358133e-12, -6.84485269462435e-12, -1.7615439232879e-12, 3.75479659610146e-11, 2.75668095508529e-11, 1.919447921093e-12, -4.99426912853067e-13];
    } else if (T >= -20 && T < -5) {
        T0 = -12.5;
        cpoly = [-0.000343537998360887, 8.23211816902089e-05, -6.5643343951617e-06, 1.72747347577359e-07, 1.50958680435296e-10, -2.9760428351363e-12];
        ccos0 = [2.68025047267915e-06, 1.68013251721868e-07, 2.86390348112698e-08, -2.63912771018793e-08, 6.68730540636839e-09, 5.69358956157231e-09, 3.86606124017216e-09, -1.52690757582471e-07, -1.81952348595773e-07, -2.00651614120009e-09, 5.64282060872819e-11];
        ccos1 = [-2.09097260873325e-07, -1.3209167463295e-08, -2.24955019101365e-09, 2.07488691657992e-09, -5.51479058032279e-10, -4.58649296917036e-10, -2.94581925688671e-10, -4.39481159566809e-09, 2.62756096408673e-09, 1.56721534510862e-10, -2.3191435105367e-12];
        ccos2 = [-5.13048171440504e-10, -2.34533780354551e-11, -3.76542367569495e-12, 5.3121900774078e-12, 1.98938262320162e-12, 6.38314423175425e-13, -1.35722295464674e-12, 8.78604280405112e-11, -1.52972942146909e-11, -5.01250642748331e-14, -1.15635989837908e-12];
        csin0 = [-2.88978236139796e-07, -2.15434001401221e-08, -3.76568711916527e-09, 3.40372277251615e-09, -9.06043077627781e-10, -7.52164723280294e-10, -4.4824603928539e-10, -1.41165592169869e-07, 9.33577070067538e-08, 1.93540213039001e-10, 5.61345979022615e-11];
        csin1 = [4.38952368555981e-08, 3.43855962414413e-09, 5.90639294474085e-10, -5.34869507360223e-10, 1.43492422975827e-10, 1.00549764260289e-10, 7.68266493040092e-11, 6.39685906665972e-09, 3.21286424903833e-09, -3.34034443301467e-11, 2.37563783073846e-12];
        csin2 = [-1.73930753222073e-09, -1.37022531713963e-10, -2.29722481682413e-11, 2.13460628048814e-11, -5.80261352705638e-12, -2.05844635925904e-12, -3.84781002175039e-12, 6.23168527957785e-11, -2.28328510946589e-11, 9.20493481362557e-13, -4.61006311338882e-13];
    } else if (T >= -40 && T < -20) {
        T0 = -30;
        cpoly = [-0.00470139632544014, 0.000466187580313599, -1.51995528953652e-05, 1.53085156444493e-07, 4.21813000723145e-10, -3.47667044244149e-12];
        ccos0 = [6.09607751927745e-06, 3.86330866626778e-07, 6.58683176660019e-08, -6.03894353708277e-08, 1.64342479778907e-08, 1.34113849436327e-08, 8.60665715969668e-09, -4.95646554123791e-08, -2.28451425768692e-07, -4.68053280185672e-09, -1.01244337249984e-10];
        ccos1 = [-1.7388977163666e-07, -1.12562554961751e-08, -1.92082346489929e-09, 1.75185935187184e-09, -5.18469575364732e-10, -3.8018008051113e-10, -2.47291472242703e-10, -7.3318552087847e-09, 2.32935905123119e-09, 1.41683712916958e-10, 6.977920111344e-12];
        ccos2 = [-1.37558833325292e-09, -8.00555648294014e-11, -1.36122685489468e-11, 1.21672356773482e-11, -3.14251110077856e-12, -4.40219663767691e-12, -1.34660545631337e-12, 8.09568596254472e-11, 2.63830663037951e-11, 7.89484877901315e-13, 4.02416742690276e-13];
        csin0 = [-1.5593821235149e-06, -1.21947405218735e-07, -2.09292691491165e-08, 1.90671524459926e-08, -5.13473418480374e-09, -3.3991407686975e-09, -2.78823560476402e-09, -2.3203637659417e-07, 2.70662385588971e-08, 1.08472534092128e-09, -2.93109074917849e-11];
        csin1 = [9.86858626152313e-08, 7.8875604978707e-09, 1.35309665538869e-09, -1.23517801766659e-09, 3.34688558910392e-10, 2.2398658150217e-10, 1.74926276764754e-10, 3.81782660410011e-09, 4.62677072574072e-09, -7.05654608653215e-11, -9.51409170682438e-13];
        csin2 = [-1.43505063881611e-09, -1.19683144900856e-10, -2.08936819195494e-11, 1.90058784116572e-11, -5.20784665143597e-12, -4.62800609264978e-12, -2.01912385672447e-12, 8.22139835311464e-11, -5.35706855141254e-11, 1.16773071573682e-12, 5.12107083575205e-13];
    } else if (T < -40) {
        T0 = -50;
        cpoly = [-0.0212507818254192, 0.00124149677610554, -2.30798189892507e-05, 1.0433378206253e-07, 8.15133170369701e-10, -4.35927983057763e-12];
        ccos0 = [8.9411103144769e-06, 5.73408912430476e-07, 9.79096941925656e-08, -8.93821327093914e-08, 2.51853815177297e-08, 1.94616596818124e-08, 1.28142781711904e-08, 1.30075807729754e-07, -2.60775821451473e-07, -6.81529668907844e-09, -9.58120036967659e-11];
        ccos1 = [-1.02360777460029e-07, -6.8490652653903e-09, -1.19029565257273e-09, 1.02965083919116e-09, -3.20518425904727e-10, -2.45602571609635e-10, -1.53514003823181e-10, -1.06942526170547e-08, 5.32124635014561e-10, 3.34810338095207e-11, -5.92355733706455e-12];
        ccos2 = [-2.20086137557861e-09, -1.4030394670984e-10, -2.29141220673813e-11, 2.39431899566857e-11, -6.75504637222171e-12, -2.32667880739783e-12, -3.34226796466269e-12, 8.71630107880522e-11, 6.34786545070366e-11, 4.62064907747056e-12, 2.42657129730152e-13];
        csin0 = [-4.05385977188384e-06, -3.23797296447837e-07, -5.56565085282591e-08, 5.09693971428318e-08, -1.39085775102084e-08, -9.1151112081115e-09, -7.39824911060193e-09, -2.69584903787612e-07, -8.87959429089917e-08, 2.97902692836024e-09, -1.025091719481e-10];
        csin1 = [1.45435916275449e-07, 1.19199709561739e-08, 2.05041063288047e-09, -1.91467974990179e-09, 5.42389122292319e-10, 2.86114099670299e-10, 3.16458916604342e-10, -6.55215032366084e-10, 7.14929669579057e-09, -1.20454706262354e-10, 3.79781637463188e-11];
        csin2 = [-9.02452044194785e-10, -8.19373780143057e-11, -1.39720169550394e-11, 1.4969208200103e-11, -5.17718151766037e-12, 1.52163018424334e-12, -5.0575081352549e-12, 1.41438098292163e-10, -7.25556129883673e-11, 1.32673155411481e-12, -2.45858572942527e-12];
    } else if (T > 5 && T < 20) {
        T0 = 12.5;
        cpoly = [0.000342435739370764, 8.19656484392364e-05, 6.52107801384716e-06, 1.70357465153538e-07, -2.04861596446454e-10, -3.17206013619773e-12];
        ccos0 = [-2.67105053534081e-06, -1.65026137311678e-07, -2.82877163874367e-08, 2.56406181437099e-08, -6.29656787799267e-09, -5.80685803142842e-09, -3.82477547250768e-09, -2.01354982434365e-07, -1.20874773467619e-07, 2.07845781280733e-09, 1.36411267059417e-10];
        ccos1 = [-2.07542334512135e-07, -1.27231141859305e-08, -2.17535803323904e-09, 1.98740118856474e-09, -4.66976063230945e-10, -4.60135229280978e-10, -2.86093421419566e-10, 8.73974060130946e-10, 2.82054597060643e-09, 1.66107436596013e-10, -3.72470310029095e-12];
        ccos2 = [5.78807567239206e-10, 4.42484765796138e-11, 8.54237362371766e-12, -4.23671606568448e-12, 3.91840562183606e-12, 7.57484065274844e-13, 1.93721417927229e-12, 1.23317614003788e-10, 3.82170795415763e-11, -4.28119846533686e-13, -2.34135908776941e-12];
        csin0 = [-2.95468839489204e-07, -2.12957050624046e-08, -3.73700038634054e-09, 3.42945820432985e-09, -8.49704753909206e-10, -7.38430403167028e-10, -4.55019747944149e-10, 4.85658325499428e-08, 1.75293650562109e-07, 1.9443899297079e-10, -1.16959458581129e-10];
        csin1 = [-4.53288704723699e-08, -3.39624076187784e-09, -5.91734320158969e-10, 5.31673189818927e-10, -1.35442690610325e-10, -1.02601807880829e-10, -8.56052504224254e-11, 8.23176044032626e-09, 3.95520266779714e-09, 3.55170791729227e-11, -4.0433317095572e-12];
        csin2 = [-1.82639185115588e-09, -1.34879364471212e-10, -2.32951019121329e-11, 2.08455721299868e-11, -5.46521672057869e-12, -2.35852152398302e-12, -4.63225806229471e-12, 9.94595083397116e-12, 3.55663329441092e-11, 1.11494419071806e-12, 6.98977559123263e-13];
    } else if (T >=20 && T < 40) {
        T0 = 30;
        cpoly = [0.0046624573557686, 0.000460812528014111, 1.49127731027072e-05, 1.45730358156382e-07, -5.14519719494154e-10, -4.00996639763615e-12];
        ccos0 = [-6.02881601563646e-06, -3.68523669229047e-07, -6.28031080541428e-08, 5.77482443387447e-08, -1.32952655819065e-08, -1.31722129561684e-08, -8.23273609586891e-09, -1.46603804896906e-07, -5.44159456471729e-08, 4.69751582426042e-09, -2.16987127206033e-10];
        ccos1 = [-1.67890958418821e-07, -1.00532434288624e-08, -1.68892055786619e-09, 1.56423606431933e-09, -3.35157530278591e-10, -3.42616868459006e-10, -2.17210443329229e-10, 5.52821298956497e-09, 5.23720229960675e-09, 1.19781156772095e-10, 9.27549515847218e-14];
        ccos2 = [1.54846312923626e-09, 1.00307180418697e-10, 1.79150935508543e-11, -1.79807191630072e-11, 3.65212243124063e-12, 5.30780499214251e-12, 1.99123827006265e-12, 1.4022373596886e-10, 9.21700067938341e-11, -1.99522410629567e-12, 1.94689221842084e-12];
        csin0 = [-1.62960134132834e-06, -1.20192926214185e-07, -2.08659808262776e-08, 1.89834166109665e-08, -4.53125438145263e-09, -3.4861688681637e-09, -2.99069924733095e-09, 1.90350218413943e-07, 2.5235373308341e-07, 1.15895858321802e-09, -5.45673077928533e-11];
        csin1 = [-1.0556153809406e-07, -7.74825900829212e-09, -1.3349638623965e-09, 1.23441243836785e-09, -2.5424126006768e-10, -2.31131983292707e-10, -1.7152599968606e-10, 7.51639486259268e-09, 4.59039359498451e-09, 7.48439351107897e-11, 4.23859850456265e-12];
        csin2 = [-1.64183949271762e-09, -1.16441388967305e-10, -1.96901506777768e-11, 1.95027833299561e-11, -1.84101593243369e-12, -4.65761762760659e-12, -8.21843916460678e-13, -4.32277420121572e-11, 5.08479665128634e-12, 1.13013465385481e-12, -1.10136658636458e-13];
    } else {
        T0 = 50;
        cpoly = [0.0209141777003451, 0.00121241161430638, 2.2084742075135e-05, 8.73841202976494e-08, -9.57255573191864e-10, -4.6502173686607e-12];
        ccos0 = [-8.67138711588247e-06, -5.23498094309595e-07, -8.90584591037633e-08, 8.16150478357301e-08, -1.80136481541044e-08, -1.85712092131104e-08, -1.18409304357393e-08, 1.97874166472493e-08, 9.19053989752425e-08, 6.47251838211235e-09, 3.45408267984888e-11];
        ccos1 = [-8.67798699621895e-08, -4.84744194627048e-09, -9.009122783597e-10, 7.99881272959372e-10, -8.42888208534346e-11, -2.64260845697086e-10, -1.49657068788903e-10, 1.10846559013818e-08, 9.86586175390946e-09, 7.54660055059284e-11, -2.78483627906834e-11];
        ccos2 = [2.50709129359534e-09, 1.59982893710897e-10, 2.14853204244703e-11, -2.02370204049908e-11, 8.89131304001719e-12, -1.39000385404653e-12, 1.38643045695365e-12, 1.37598409621982e-10, 1.39262965921301e-10, -2.20533457012626e-13, -3.34394810553424e-12];
        csin0 = [-4.34453279848331e-06, -3.17102424557362e-07, -5.4681823244068e-08, 5.02590431280026e-08, -1.07363579510856e-08, -9.59656976046419e-09, -7.16383287804033e-09, 3.15105252102392e-07, 3.36004433984488e-07, 3.17909681395901e-09, 8.51113220386846e-11];
        csin1 = [-1.60628097440109e-07, -1.1479467085067e-08, -1.97067086925752e-09, 1.77177665510542e-09, -4.04656296426215e-10, -3.42379523477714e-10, -2.87174970425271e-10, 4.13093183039797e-09, 2.75556752921065e-09, 1.34290454661637e-10, 1.96253967980775e-11];
        csin2 = [-1.11148847458481e-09, -7.0119014871438e-11, -1.20951996652741e-11, 7.36542750692248e-12, -5.67973588549309e-12, -9.04759381643776e-13, -4.96060462049991e-12, -1.26045409597578e-10, -9.68260999399793e-11, 1.84219132368757e-12, 8.79476573312203e-13];
    }

    return {T0:T0, cpoly:cpoly, ccos0:ccos0, ccos1:ccos1, ccos2:ccos2, csin0:csin0, csin1:csin1, csin2:csin2};
}
